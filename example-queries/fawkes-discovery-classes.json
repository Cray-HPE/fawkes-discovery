{
    "nodeClass": [
      { "$unwind": "$storage" },
      { "$unwind": "$disk" },
      { "$unwind": "$volume" },
      { "$match": { "$and": [ { "storage.class": "storage", "$or": [ { "storage.id": { "$regex": "^nvme.*" } }, { "storage.id": { "$regex": "^sata.*" } }, { "storage.id": { "$regex": "^sas.*" } } ] } ] } },
      { "$group": { "_id": "$_id", "storage": { "$addToSet": "$storage" } } },
      { "$project": { "diskCount": { "$size": "$storage" } } },
      { "$project": { "diskCount": "$diskCount", "nodeClass": { "$switch": { "branches": [ { "case": { "$lte": [ "$diskCount", "2" ] }, "then": "hypervisor" }, { "case": { "$gte": [ "$diskCount", "6" ] }, "then": "storage" } ], "default": "" } } } },
      { "$merge": { "into": "lshw", "on": "_id", "whenMatched": "merge" } }
    ],
    "totalRamGB": [
      { "$unwind": "$memory" },
      { "$match": { "$and": [ { "memory.id": "memory" }, { "memory.class": "memory" }, { "memory.size": { "$exists": true } } ] } },
      { "$group": { "_id": "$_id", "totalRamGB": { "$first": { "$divide": [ "$memory.size", 1073741824 ] } } } },
      { "$merge": { "into": "lshw", "on": "_id", "whenMatched": "merge" } }
    ],
    "cpuCoreQty": [
      { "$match": { "$and": [ { "processor.configuration.cores": { "$exists": true } }, { "processor.id": { "$regex": "^cpu.*" } } ] } },
      { "$set": { "cpuCoreQty": { "$map": { "input": "$processor.configuration.cores", "in": { "$toInt": "$$this" } } } } },
      { "$set": { "cpuCoreQty": { "$sum": "$cpuCoreQty" } } },
      { "$merge": { "into": "lshw", "on": "_id", "whenMatched": "merge" } }
    ]
}
